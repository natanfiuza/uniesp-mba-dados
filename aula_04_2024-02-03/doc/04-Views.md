# Views

As Views no SQL são a possibilidade de armazenar o resultado de um query dentro de uma tabela virtual que pode facilitar a utilização delas posteriormente.

Dessa forma não vai precisar ficar refazendo suas análises para obter os mesmos resultados novamente.

## Diferenças

|     | Tabela    |  View   |
| --- | --- | --- |
| Definição |  Uma tabela é um objeto que armazena os dados dentro de um banco de dados.   |  Uma view é um objeto que permite gerar um conjunto de dados a partir da consulta a uma ou mais tabelas.   |
| Dependência | Uma tabelaé um objeto independente.    |  Uma view depende de uma ou mais tabelas.   |
| Manipulação de dados | Podemos adicionar, atualizar ou excluir dados a partir de uma tabela.    |  Não e possível adicionar, atualizar ou excluir dados a partir de uma view.   |
| Armazenamento | Uma tabea armazena dados.     | Uma view armazena uma query ( consulta )    |

### Vantagens


| Reutilização | Segurança | Ganho de tampo |
| --- | ------ | ---- |
| Sempre que necessário podemos consultar aquela View, pois ela fica armazenada no sistema. | Ao criar uma View, estamos ocultando linhas ou colunas da tabela original do banco de dados. Desta forma, apenas algumas informações relevantes serão visualizadas na View. | QUando criamos Views, estamos poupando o tempo de recriar vários `SELECTs`, o que aumenta a produtividade.  |

## Comandos

| Ação  | Comando |
| --- | --- |
|Criação de uma View | `CREATE VIEW` |
|Alteração de uma View | `ALTER VIEW` |
|Exclusão de uma View | `DROP VIEW` |

### CREATE VIEW

Cria um view para armazenas apenas Clientes do tipo 1 

```sql

CREATE VIEW vw_clientes_por_tipo AS
SELECT * FROM clientes
WHERE tipo_cliente_id = 1

```

Alterar a view anterior para listar Clientes do tipo 2

```sql

CREATE OR ALTER VIEW vw_clientes_por_tipo AS
SELECT * FROM clientes
WHERE tipo_cliente_id = 2

```

Excluir a view criada anteriormente

```sql

DROP VIEW vw_clientes_por_tipo;

```


---

## Query da aula sobre views

Segue abaixo as querys da aula sobre views.

```sql

--CRIAÇÃO, ALTERAÇÃO, REMOÇÃO DE VIEWS
--INSERTS ATRAVÉS DE VIEWS


USE DISCIPLINA02
GO

--CRIE UMA VIEW QUE LISTE O NOME E CPF DOS CLIENTES
CREATE VIEW VW_CLIENTES_01
AS
SELECT NOME, CPF
FROM CLIENTES;
GO

SELECT *
FROM VW_CLIENTES_01;
GO

SELECT *
FROM VW_CLIENTES_01
ORDER BY CPF DESC;
GO

--CRIE UMA VIEW QUE LISTE O NOME E CPF DOS CLIENTES, ORDENADA PELO NOME EM ORDEM DESCENDENTE
CREATE VIEW VW_CLIENTES_02
AS
SELECT NOME, CPF
FROM CLIENTES
ORDER BY NOME DESC;
GO

--CRIE UMA VIEW QUE LISTE OS 10 PRIMEIROS NOMES E CPFS DOS CLIENTES, ORDENADA PELO NOME EM ORDEM DESCENDENTE
CREATE VIEW VW_CLIENTES_02
AS
SELECT TOP 10 NOME, CPF
FROM CLIENTES
ORDER BY NOME DESC;
GO

--CRIE UMA VIEW QUE LISTE O NOME E CPF DOS CLIENTES CUJO CPF SEJA MENOR QUE 10
CREATE VIEW VW_CLIENTES_03
AS
SELECT NOME as CLIENTE, CPF
FROM CLIENTES
WHERE CPF < 10;
GO

SELECT *
FROM VW_CLIENTES_03;
GO

--REMOVA A ÚLTIMA VIEW CRIADA
DROP VIEW VW_CLIENTES_03;
GO

--ALTERE A PRIMEIRA VIEW PARA QUE QUE LISTE O NOME (LISTADO COMO "CLIENTE") E CPF DOS CLIENTES
ALTER VIEW VW_CLIENTES_01
AS
SELECT NOME AS CLIENTE, CPF
FROM CLIENTES;
GO

SELECT *
FROM VW_CLIENTES_01;
GO

SELECT *
FROM SYS.SYSCOMMENTS
WHERE OBJECT_NAME(ID) = 'VW_CLIENTES_01';
GO

--CRIE UMA VIEW CUJO CONTEÚDO/COMANDO SQL DA MESMA SEJA ENCRIPTADO
CREATE VIEW VW_CLIENTES_04
WITH ENCRYPTION
AS
SELECT NOME AS CLIENTE, CPF
FROM CLIENTES
GO


SELECT OBJECT_NAME(ID), TEXT
FROM SYS.SYSCOMMENTS
WHERE OBJECT_NAME(ID) LIKE 'VW_CLIENTES_0%';
GO

--CRIE UMA VIEW QUE NÃO PERMITA QUE OS OBJETOS/COLUNAS DOS QUAIS ELA DEPENDE SEJAM ALTERADOS DE FORMA QUE AFETE A VIEW
CREATE VIEW VW_ITENS_VENDAS_01
WITH SCHEMABINDING 
AS
SELECT IDVENDA, SUM(VALOR*QUANTIDADE) AS TOTAL
FROM dbo.ITENS_VENDAS
GROUP BY IDVENDA;
GO

--REMOVA A TABELA ITENS_VENDAS
DROP TABLE ITENS_VENDAS;
GO

--ADICIONE UMA COLUNA A TABELA ITENS_VENDAS
ALTER TABLE ITENS_VENDAS
ADD TESTE INT NULL;
GO

--REMOVA A COLUNA ADICIONADA NO ITEM ANTERIOR
ALTER TABLE ITENS_VENDAS
DROP COLUMN TESTE;
GO

--REMOVA A COLUNA QUANTIDADE DA TABELA ITENS_VENDAS
ALTER TABLE ITENS_VENDAS
DROP COLUMN QUANTIDADE;
GO

--ADICIONE UMA COLUNA A TABELA ITENS_VENDAS
ALTER TABLE ITENS_VENDAS
ADD TESTE INT NULL;
GO

--CRIE UMA VIEW UTILIZANDO A COLUNA CRIADA NO ITEM ANTERIOR
CREATE VIEW VW_ITENS_VENDAS_02
AS
SELECT TESTE
FROM ITENS_VENDAS;
GO

SELECT *
FROM VW_ITENS_VENDAS_02;
GO

--REMOVA A COLUNA CRIADA NO PENÚLTIMO ITEM
ALTER TABLE ITENS_VENDAS
DROP COLUMN TESTE;
GO

SELECT *
FROM VW_ITENS_VENDAS_02;
GO

--REMOVA A VIEW CRIADA NO PENÚLTIMO ITEM
DROP VIEW VW_ITENS_VENDAS_02;
GO

--OPERAÇÕES DML COM VIEWS
CREATE VIEW VW_UFS
AS
SELECT IDUF, UF
FROM UFS;

INSERT INTO VW_UFS
(UF)
VALUES
('XX');

SELECT *
FROM VW_UFS
WHERE UF = 'XX';

UPDATE VW_UFS
SET UF = 'YY'
WHERE UF = 'XX';

SELECT *
FROM VW_UFS
WHERE UF = 'YY';

DELETE FROM UFS
WHERE UF = 'YY';

SELECT *
FROM VW_UFS
WHERE UF = 'YY';




--CRIE UMA VIEW QUE LISTE AS 10 VENDAS DE MAIOR VALOR TOTAL
CREATE VIEW VW_VENDAS_01
AS
SELECT TOP 10 V.IDVENDA, SUM(VALOR*QUANTIDADE) AS TOTAL
FROM VENDAS AS V
INNER JOIN ITENS_VENDAS AS IV ON (V.IDVENDA = IV.IDVENDA)
GROUP BY V.IDVENDA
ORDER BY SUM(VALOR*QUANTIDADE);
GO

SELECT *
FROM VW_VENDAS_01;
GO

--CRIE UMA VIEW QUE LISTE AS 10 VENDAS MAIS RECENTES
CREATE VIEW VW_VENDAS_02
AS
SELECT TOP 10 *
FROM VENDAS
ORDER BY DATA DESC;
GO

--COMENTAR SOBRE SELECT * NA VIEW





----EXEMPLOS "EXTRAS"

--CRIE UMA VIEW QUE LISTE OS ITENS DE VENDA CUJO VALOR SEJA MAIOR QUE 5000, E QUE IMPEÇA INSERÇÃO/ATUALIZAÇÃO DE REGISTROS ATRAVÉS DA MESMA QUE NÃO RESPEITEM ESSE MESMO LIMITE DE 5000
CREATE VIEW VW_ITENS_VENDAS_03
AS
SELECT * 
FROM ITENS_VENDAS
WHERE VALOR > 5000
WITH CHECK OPTION;
GO

SELECT *
FROM VW_ITENS_VENDAS_03
WHERE IDVENDA = 1
ORDER BY NUMERO_ITEM;
GO

--INSERA UM ITEM DE VENDA ATRAVÉS DA VIEW CRIADA NO ITEM ANTERIOR, COM O VALOR = 100
INSERT INTO VW_ITENS_VENDAS_03
(IDVENDA,NUMERO_ITEM,IDPRODUTO,VALOR,QUANTIDADE)
SELECT 1,11,310,100,1;
GO

--INSERA UM ITEM DE VENDA ATRAVÉS DA VIEW CRIADA NO ITEM ANTERIOR, COM O VALOR = 5100
INSERT INTO VW_ITENS_VENDAS_03
(IDVENDA,NUMERO_ITEM,IDPRODUTO,VALOR,QUANTIDADE)
SELECT 1,11,310,5100,1;
GO

SELECT *
FROM VW_ITENS_VENDAS_03
WHERE IDVENDA = 1
ORDER BY NUMERO_ITEM;
GO

--ATUALIZE UM ITEM DE VENDA ATRAVÉS DA VIEW CRIADA NO PENÚLTIMO ITEM, ALTERANDO SEU VALOR PARA 5000
UPDATE VW_ITENS_VENDAS_03
SET VALOR = 5000
WHERE IDVENDA = 1 AND NUMERO_ITEM = 11;
GO

--REPITA A OPERAÇÃO, MAS AGORA ALTERANDO O VALOR PARA 5001
UPDATE VW_ITENS_VENDAS_03
SET VALOR = 5001
WHERE IDVENDA = 1 AND NUMERO_ITEM = 11;
GO

--REMOVA A VENDA ALTERADA NO ITEM ANTERIOR
DELETE FROM VW_ITENS_VENDAS_03
WHERE IDVENDA = 1 AND NUMERO_ITEM = 11;
GO



CREATE VIEW VW_INSERT
AS
SELECT V.*, IV.QUANTIDADE
FROM VENDAS V
INNER JOIN ITENS_VENDAS IV ON (V.IDVENDA = IV.IDVENDA);
GO

SELECT * FROM VW_INSERT
ORDER BY DATA DESC;
GO


INSERT INTO VW_INSERT
(DATA,IDCLIENTE)
VALUES
(GETDATE(),1);
GO

SELECT *
FROM VW_INSERT
ORDER BY DATA DESC;
GO

SELECT *
FROM VENDAS
ORDER BY DATA DESC;
GO

--VER O ID_VENDA CORRETO
INSERT INTO ITENS_VENDAS
(IDVENDA,NUMERO_ITEM,IDPRODUTO,VALOR,QUANTIDADE)
VALUES
(3004,12,1,50,2);
GO

SELECT *
FROM VW_INSERT
ORDER BY DATA DESC;
GO

```