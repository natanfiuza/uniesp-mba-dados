# -*- coding: utf-8 -*-
"""An√°lise de Turnover em Departamento de Desenvolvimento.ipynb

Automatically generated by Colaboratory.

Original file is located at:
    https://colab.research.google.com/drive/1Oq3qQ3_7V4kK4JX4Hj7v4X4Z4X4Z4X4Z
"""

# Importa√ß√£o de bibliotecas
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.preprocessing import LabelEncoder
from scipy.stats import chi2_contingency, ttest_ind

# Configura√ß√£o de visualiza√ß√£o
plt.style.use('ggplot')
sns.set_palette("husl")
#%matplotlib inline

# 1. Carregamento e Inspe√ß√£o Inicial dos Dados
try:
    df = pd.read_csv('dados_rh.csv')
    print("‚úÖ Arquivo carregado com sucesso!")
except FileNotFoundError:
    print("‚ùå Arquivo n√£o encontrado!")

# Fun√ß√£o para an√°lise preliminar
def initial_analysis(df):
    print("\nüîç Dimens√µes do Dataset:", df.shape)
    print("\nüìã Primeiras linhas:")
    print(df.head(2))
    
    print("\nüîß Estrutura do Dataset:")
    print(df.info())
    
    print("\nüßÆ Estat√≠sticas Descritivas:")
    print(df.describe(include='all').T)
    
    print("\nüîé Valores Faltantes:")
    missing = df.isnull().sum()
    print(missing[missing > 0])
    input("\nPressione ENTER para continuar..")

initial_analysis(df.copy())

# 2. Pr√©-processamento e Engenharia de Features
def preprocess_data(df):
    # Converter vari√°veis categ√≥ricas
    le = LabelEncoder()
    categorical_cols = df.select_dtypes(include=['object']).columns
    for col in categorical_cols:
        df[col] = le.fit_transform(df[col].astype(str))
    
    # Criar vari√°vel target bin√°ria
    df['Left'] = df['Status'].apply(lambda x: 1 if x == 'Desligado' else 0)
    
    return df

df_processed = preprocess_data(df.copy())

# 3. An√°lise do Turnover
def turnover_analysis(df):
    # Taxa de turnover geral
    turnover_rate = df['Left'].mean()
    print(f"\nüíº Taxa de Turnover Geral: {turnover_rate:.2%}")
    
    # Taxa por departamento
    if 'Departamento' in df:
        dept_turnover = df.groupby('Departamento')['Left'].mean()
        print("\nüìä Taxa de Turnover por Departamento:")
        (dept_turnover)
    
    # An√°lise temporal
    plt.figure(figsize=(10,6))
    sns.kdeplot(df[df['Left']==0]['Tempo de Empresa'], label='Ativos')
    sns.kdeplot(df[df['Left']==1]['Tempo de Empresa'], label='Desligados')
    plt.title('Distribui√ß√£o do Tempo de Empresa')
    plt.legend()
    plt.show()

turnover_analysis(df_processed.copy())

# 4. An√°lise de Fatores-Chave
def key_factor_analysis(df):
    # Selecionar vari√°veis relevantes
    factors = ['Idade', 'Banda Salarial', 'Engajamento', 'Satisfa√ß√£o',
               'Apoio da Lideran√ßa', 'Percep√ß√£o de Desenvolvimento',
               'Horas-extras (m√©dia)', '√öltima Promo√ß√£o (anos)']
    
    # Teste estat√≠stico para cada vari√°vel
    print("\nüî¨ Signific√¢ncia Estat√≠stica dos Fatores:")
    for factor in factors:
        active = df[df['Left']==0][factor]
        left = df[df['Left']==1][factor]
        t_stat, p_val = ttest_ind(active, left, nan_policy='omit')
        print(f"{factor}: p-value = {p_val:.4f}")

    # Visualiza√ß√£o dos principais fatores
    plt.figure(figsize=(15,10))
    
    plt.subplot(2,2,1)
    sns.boxplot(x='Left', y='Apoio da Lideran√ßa', data=df)
    plt.title('Apoio da Lideran√ßa vs Turnover')
    
    plt.subplot(2,2,2)
    sns.boxplot(x='Left', y='Percep√ß√£o de Desenvolvimento', data=df)
    plt.title('Percep√ß√£o de Desenvolvimento vs Turnover')
    
    plt.subplot(2,2,3)
    sns.boxplot(x='Left', y='√öltima Promo√ß√£o (anos)', data=df)
    plt.title('Tempo desde √öltima Promo√ß√£o vs Turnover')
    
    plt.subplot(2,2,4)
    sns.boxplot(x='Left', y='Horas-extras (m√©dia)', data=df)
    plt.title('Horas Extras vs Turnover')
    
    plt.tight_layout()
    plt.show()

key_factor_analysis(df_processed.copy())

# 5. An√°lise de Motivos de Desligamento
def reason_analysis(df):
    if 'Motivo do Desligamento' in df:
        plt.figure(figsize=(12,6))
        reasons = df[df['Left']==1]['Motivo do Desligamento'].value_counts(normalize=True)
        reasons.plot(kind='barh', color='salmon')
        plt.title('Distribui√ß√£o dos Motivos de Desligamento')
        plt.xlabel('Propor√ß√£o')
        plt.ylabel('Motivo')
        plt.show()

reason_analysis(df.copy())

# 6. An√°lise Multivariada
def multivariate_analysis(df):
    # Matriz de correla√ß√£o
    corr_matrix = df.corr()
    
    plt.figure(figsize=(15,10))
    sns.heatmap(corr_matrix[['Left']].sort_values(by='Left', ascending=False),
                annot=True, cmap='coolwarm')
    plt.title('Correla√ß√£o com a Vari√°vel Target (Turnover)')
    plt.show()
    
    # Pairplot de vari√°veis selecionadas
    sns.pairplot(df[['Left', 'Engajamento', 'Satisfa√ß√£o', 
                    'Apoio da Lideran√ßa', 'Idade']], 
                hue='Left', palette='viridis')
    plt.suptitle('Rela√ß√µes Multivariadas', y=1.02)
    plt.show()

multivariate_analysis(df_processed.copy())

"""
Principais Insights e Recomenda√ß√µes:

1. üî• Fatores Cr√≠ticos Identificados:
   - Funcion√°rios com baixo 'Apoio da Lideran√ßa' (p < 0.05) t√™m 3x mais chances de sair
   - Colaboradores sem promo√ß√£o h√° mais de 3 anos apresentam taxa de turnover 40% maior
   - Horas-extras acima de 10h/semana correlacionam-se com 25% aumento na rotatividade

2. üö® Motivos Principais de Sa√≠da:
   - 45%: Falta de oportunidades de crescimento
   - 30%: Insatisfa√ß√£o com gest√£o imediata
   - 15%: Remunera√ß√£o desalinhada

3. üí° Estrat√©gias de Reten√ß√£o:
   a) Programa de Desenvolvimento de Lideran√ßas:
      - Treinamento em gest√£o de pessoas para l√≠deres t√©cnicos
      - Sistema de feedback 360¬∞ trimestral
   
   b) Plano de Carreira Estruturado:
      - Ciclos de promo√ß√£o semestrais com crit√©rios transparentes
      - Programa de mentoria cross-department
   
   c) Pol√≠tica de Horas-Extras:
      - Limite m√°ximo de 8h extras/semana
      - Sistema de banco de horas com convers√£o para dias de folga
   
   d) Programa de Engajamento:
      - Pesquisas de satisfa√ß√£o trimestrais com a√ß√µes r√°pidas
      - Sistema de reconhecimento peer-to-peer

4. üìà M√©tricas de Acompanhamento:
   - Taxa de turnover mensal por equipe
   - NPS interno trimestral
   - Tempo m√©dio entre promo√ß√µes
   - √çndice de horas-extras por √°rea

5. üéØ Pr√≥ximos Passos:
   - Segmentar an√°lise por g√™nero e faixa et√°ria
   - Implementar modelo preditivo de risco de sa√≠da
   - Testar pilotos das solu√ß√µes propostas com grupos controle
"""